<section ng-if="!hasAccess && !loading">
    <h3 class="text-center">You can not access this page.</h3>
</section>

<section ng-if="hasAccess">
    <!--Problem header-->
    <section class='row' fixed-zone id='problem-header'
             ng-class='problem.is_controlled==true ? "problem-controlled" : "problem-uncontrolled"'
             offset-orientation='top'
             offset-top='100'>
        <div class="col-md-6">
            <div class="todo">
                <h4 ng-show="!edit_problem">
                    Problem : {{ problem.problem_name }}
                    <span ng-if="problem && !problem.authenticated">(not authenticated)</span>
                    <!-- begin label -->
                    <span class="quick-card-editor-label">
                        <a class="todo-label" href ng-class="label.css_class" ng-if="label.author.id==user_id"
                           ng-repeat="label in problem.labels"></a>
                    </span>
                    <!-- end label -->
                    <!-- begin sharing patients -->
                    <span ng-if="isInArray(p.problems, problem.id)" ng-repeat="p in sharing_patients">
                        <img class='tiny-img' ng-src="{{ p.portrait_image }}" title="{{ p.user.first_name }}" alt="">
                    </span>
                    <!-- end sharing patients -->
                    <a class="btn-custom" href ng-click="edit_problem=!edit_problem"><i class="fa fa-pencil"></i></a>
                </h4>

                <!-- begin change item -->
                <div class="quick-card-editor" id="main-menu" ng-show='edit_problem'>
                    <!-- show label and text in edit mode -->
                    <div class="quick-card-editor-text">
                        <div class='row' ng-show='permitted(["change_problem_name"])'>
                            <div class='col-md-12'>
                                <input class='form-control' id='problemTermInput'
                                       ng-change="problem_name_changed(problem_term);" ng-model='problem_term'
                                       ng-model-options="{ updateOn: 'default blur', debounce: { default: 1000, blur: 500 } }"
                                       placeholder='Search Problem....'
                                       type='text'>
                                <button class='btn btn-sm btn-default' ng-click='change_new_problem_name(problem_term)'>
                                    Change Problem
                                </button>
                                <div ng-show='new_problem.set==true'>
                                    <hr>
                                    <label> {{ new_problem.code }} </label>
                                    {{ new_problem.term }} <br>
                                    <button class='btn btn-sm btn-default' ng-click='change_problem_name()'>
                                        Change Problem
                                    </button>
                                    <button class='btn btn-sm btn-default' ng-click='unset_new_problem()'>
                                        Cancel
                                    </button>
                                    <hr>
                                </div>
                            </div>
                            <div class='col-md-12' style='max-height:375px; overflow-y:auto;'>
                                <div ng-repeat='problem_term in problem_terms' style='margin-top:12px;'>
                                    <button class='btn btn-sm btn-default' ng-click='set_new_problem(problem_term)'
                                            title='{{ problem_term.code }}'>
                                        {{ problem_term.term }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end show label and text in edit mode -->
                    <div class="quick-card-editor-card">
                        <!-- begin buttons -->
                        <div class="quick-card-editor-buttons">
                            <a href ng-click="edit_problem=!edit_problem; $event.stopPropagation();"><i
                                    class="fa fa-close"></i></a>
                            <a href ng-click="open_change_problem_label();"><i class="fa fa-tags"></i>Edit label</a>
                            <a href ng-click="open_create_label_problems_list();"
                               ng-if="active_user.role=='physician' || active_user.role=='patient' || active_user.role=='mid-level'"><i
                                    class="fa fa-tags"></i>Create problems list</a>
                            <a href ng-click="open_change_data();"><i class="fa fa-tags"></i>Change Data</a>
                            <a href ng-click="open_change_medication();"><i class="fa fa-tags"></i>Change Medication</a>
                            <a href ng-click="delete_problem();"
                               ng-if="(active_user.role=='physician' || active_user.role=='admin' || active_user.role=='mid-level') && encounter_flag"><i
                                    class="fa fa-tags"></i>Delete problem</a>
                        </div>
                        <!-- end buttons -->
                        <!-- begin change label -->
                        <div class="quick-card-editor-lv2" ng-if="change_problem_label">
                            <div class="quick-card-editor-lv2-header">
                                <a href ng-click="close_change_problem_label(); $event.stopPropagation();"><i
                                        class="fa fa-close"></i></a>
                            </div>
                            <div ng-repeat="label in problem_labels">
                                <a class="todo-label" href ng-class="label.css_class"
                                   ng-click="changeProblemLabel(problem, label)">
                                    {{ label.name }}
                                    <i class="fa fa-check" ng-if="l.id==label.id" ng-repeat="l in problem.labels"></i>
                                </a>
                                <!-- begin edit label -->
                                <a class="todo-label-edit" href ng-click="editProblemLabel(label)"
                                   ng-if="user_id==label.author.id"><i class="fa fa-pencil"></i></a>
                                <div class="quick-card-editor-lv2 quick-card-editor-lv3 top-left-0"
                                     ng-if="label.edit_label">
                                    <div class="quick-card-editor-lv2-header">
                                        <a href ng-click="editProblemLabel(label); $event.stopPropagation();"><i
                                                class="fa fa-close"></i></a>
                                    </div>
                                    <input ng-model="label.name" type="text">
                                    <a class="todo-label" href ng-class="component.css_class"
                                       ng-click="selectEditProblemLabelComponent(label, component)"
                                       ng-repeat="component in problem_labels_component">
                                        <i class="fa fa-check" ng-if="component.css_class==label.css_class"></i>
                                    </a>
                                    <a href ng-click="saveEditProblemLabel(label)">Save</a>
                                    <a class="btn btn-danger" href ng-click="deleteEditProblemLabel(label)">Delete</a>
                                </div>
                                <!-- end edit label -->
                            </div>
                            <a href ng-click="open_create_problem_label();"><i class="fa fa-tags"></i>Create new
                                label</a>
                        </div>
                        <div class="quick-card-editor-lv2 quick-card-editor-lv3" ng-if="create_problem_label">
                            <div class="quick-card-editor-lv2-header">
                                <a href ng-click="close_create_problem_label(); $event.stopPropagation();"><i
                                        class="fa fa-close"></i></a>
                            </div>
                            <input ng-model="problem_label_component.name" type="text">
                            <a class="todo-label" href ng-class="component.css_class"
                               ng-click="selectProblemLabelComponent(component)"
                               ng-repeat="component in problem_labels_component">
                                <i class="fa fa-check"
                                   ng-if="component.css_class==problem_label_component.css_class"></i>
                            </a>
                            <a href ng-click="saveCreateProblemLabel(problem)">Save</a>
                        </div>
                        <!-- end change label -->
                        <!-- begin create label problems list -->
                        <div class="quick-card-editor-lv2" ng-if="create_label_problems_list">
                            <div class="quick-card-editor-lv2-header">
                                <a href ng-click="close_create_label_problems_list(); $event.stopPropagation();"><i
                                        class="fa fa-close"></i></a>
                            </div>
                            <form class='form-inline' ng-submit='add_problem_list(new_list)' role='form'>
                                <div class='form-group'>
                                    <input ng-model='new_list.name' type='text'>
                                    <div ng-repeat="label in problem_labels">
                                        <a class="todo-label" href ng-class="label.css_class"
                                           ng-click="add_new_list_label(new_list, label)">
                                            {{ label.name }}
                                            <i class="fa fa-check" ng-if="l.id==label.id"
                                               ng-repeat="l in new_list.labels"></i>
                                        </a>
                                    </div>
                                </div>
                                <br>
                                <button class='btn btn-default' type='submit'> Add List</button>
                            </form>
                        </div>
                        <!-- end create label problems list -->
                        <!-- begin change data -->
                        <div class="quick-card-editor-lv2" ng-if="change_pinned_data" style="color: black;">
                            <div class="quick-card-editor-lv2-header">
                                <a href ng-click="close_change_data(); $event.stopPropagation();"><i
                                        class="fa fa-close"></i></a>
                            </div>
                            <div class="checkbox" ng-repeat="data in datas track by $index">
                                <input id="{{ data.id }}"
                                       ng-change="data_pin_to_problem(data.id, problem.id);"
                                       ng-disabled="active_user.role == 'patient' && active_user.user.id != data.pin_author && data.pin_author != null"
                                       ng-model="data.pin"
                                       title="{{ data.name }}"
                                       type="checkbox">
                                <label for="{{ data.id }}" ng-bind="data.name">
                                </label>
                            </div>
                        </div>
                        <!-- end change data -->
                        <!-- begin change medication -->
                        <div class="quick-card-editor-lv2" ng-if="change_pinned_medication"
                             id="problem-medication-select">
                            <div class="quick-card-editor-lv2-header">
                                <a sb-click-track ng-click="close_change_medication(); $event.stopPropagation();"><i
                                        class="fa fa-close"></i></a>
                            </div>
                            <div class="checkbox" ng-repeat="medication in medications track by $index">
                                <input id="{{ medication.id }}"
                                       ng-change="medication_pin_to_problem(medication, problem.id);"
                                       ng-disabled="active_user.role == 'patient' && (active_user.id != medication.pin_author || medication.pin_author != null)"
                                       ng-model="medication.pin"
                                       title="{{ medication.name }}"
                                       type="checkbox">
                                <label for="{{ medication.id }}">{{ medication.name }}</label>
                            </div>
                        </div>
                        <!-- end change medication -->
                    </div>
                </div>
                <!-- end change item -->
            </div>
        </div>

        <div class='col-md-6 text-right'>
            <div class='form-inline' ng-show='permitted(["modify_problem"])'>
                <label for="start-date">Start date </label>
                <div class="input-group">
                    <input id="start-date" class='form-control'
                           uib-datepicker-popup="{{startDateFormat}}"
                           popup-placement="bottom-right"
                           is-open="startDateOpen"
                           datepicker-options="startDateOptions"
                           ng-change="update_start_date(startDate)"
                           ng-model='startDate'>
                    <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="startDateOpen =!startDateOpen "><i
                            class="fa fa-calendar"></i></button>
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- Problem status-->
    <section class='panel panel-default'>
        <div class='panel-body'>
            <div class='row'>
                <div class='col-md-4'>
                    <!--Only show if edit mode is enabled-->
                    <div class="checkbox">
                        <input id="controller-switch" ng-disabled='!permitted(["set_problem_controlled"])'
                               ng-model='problem.is_controlled'
                               type='checkbox'>
                        <label for="controller-switch"> Is controlled </label>
                    </div>
                </div>
                <div class='col-md-4'>
                    <div class="checkbox">
                        <input id="authenticated-switch" ng-disabled='!permitted(["set_problem_authenticated"])'
                               ng-model='problem.authenticated'
                               type='checkbox'>
                        <label for="authenticated-switch">Is authenticated</label></div>
                </div>
                <div class='col-md-4'>
                    <div class="checkbox">
                        <input id="active-switch" ng-disabled='!permitted(["set_problem_active"])'
                               ng-model='problem.is_active'
                               type='checkbox'>
                        <label for="active-switch">Is active</label></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Problem todo-->
    <section class="row">
        <div class="col-md-6">
            <div class='panel panel-default'>
                <div class='panel-heading'>Tasks</div>
                <div class='panel-body'>
                    <!-- Form adding new todo(wiki_note_form is out of scope w/ problem controller)-->
                    <form ng-submit='add_todo(todo_form)'>
                        <div class='input-group'>
                            <input class='form-control' id='todoNameInput'
                                   ng-attr-tabindex="{{ problemWikiNote ? 3: 2}}"
                                   ng-model='todo_form.name'
                                   type='text'>
                            <span class="input-group-btn">
                            <input class='btn btn-default' ng-attr-tabindex="{{ problemWikiNote ? 4 : 3}}" type='submit'
                                   value='Submit'></span>
                        </div>
                    </form>

                    <!-- Scroll view-->
                    <div infinite-scroll="loadMoreTodo(false)">
                        <!--on-status-changed-success="updateStatusCallback"-->
                        <todo active-user="active_user" labels="labels"
                              members="members" patient-id="patient_id"
                              show-problem="false" todo-list="pending_todos" user-id="patient_id"></todo>
                        <wave-spinner ng-if="todoIsLoading"></wave-spinner>
                    </div>

                    <!--Toggle button-->
                    <button class='btn btn-default btn-block'
                            ng-bind='show_accomplished_todos?"Hide accomplished Tasks ":"Show accomplished Tasks"'
                            ng-click='toggle_accomplished_todos()'>
                    </button>

                    <!--Scroll view-->
                    <div ng-show='show_accomplished_todos'>
                        <!--on-status-changed-success="updateStatusCallback"-->
                        <todo active-user="active_user" labels="labels"
                              members="members" patient-id="patient_id"
                              show-problem="false" todo-list="accomplished_todos"
                              user-id="patient_id"></todo>
                        <wave-spinner ng-if="!accomplishedTodoLoaded"></wave-spinner>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <problem-note on-note-changed="onProblemWikiNoteChanged(note)" problem-id="problem.id"></problem-note>
        </div>
    </section>

    <!--A1C widget-->
    <section class="row" ng-if="availableWidgets.indexOf('a1c') != -1 && a1c != null">
        <div class="col-md-12">
            <a1c a1c="a1c"
                 active-user="active_user"
                 labels="labels"
                 members="members"
                 order-added="A1COrderAdded" order-status-changed="A1COrderStatusChanged"></a1c>
        </div>
    </section>

    <!--Colon cancer widget-->
    <section class='row' ng-if="availableWidgets.indexOf('colon_cancers') != -1 && colon_cancers!=null">
        <div class="col-md-12">
            <colon-cancer active-user="active_user"
                          colon-cancer="colon_cancers"
                          labels="labels"
                          members="members"
                          order-added="colonCancersOrderAdded"
                          order-status-changed="colonCancersOrderStatusChanged"></colon-cancer>
        </div>
    </section>

    <!-- Problem old name-->
    <section class='panel panel-default' ng-show="problem.old_problem_name">
        <div class='panel-body'>
            This problem was previously named "{{ problem.old_problem_name }}"
        </div>
    </section>

    <!-- Problem data & meditation-->
    <section class="row">
        <div ng-class="hasPinnedGraph  && hasPinnedMedication ? 'col-md-6' :'col-md-6'" ng-if="hasPinnedGraph">
            <div class='panel panel-default'>
                <div class="panel-header">
                    <div class="btn-group btn-group-justified graph-view-mode">
                        <label class="btn btn-default" ng-class="viewMode=='Week'?'mode-active':'mode-inactive'"
                               ng-click="changeView('Week')">Week</label>
                        <label class="btn btn-default" ng-class="viewMode=='Month'?'mode-active':'mode-inactive'"
                               ng-click="changeView('Month')">Month</label>
                        <label class="btn btn-default" ng-class="viewMode=='Year'?'mode-active':'mode-inactive'"
                               ng-click="changeView('Year')">Year</label>
                        <label class="btn btn-default" ng-class="viewMode=='All'?'mode-active':'mode-inactive'"
                               ng-click="changeView('All')">All</label>
                    </div>
                </div>
                <div class='panel-body no-padding'>
                    <div>
                        <ul class='ul-clean no-padding'>
                            <li ng-click='open_data(data)'
                                ng-repeat="data in datas"
                                ng-show="data.pin">
                                <div class='item-box data-frame'
                                     ng-style="{'background-color': data.color}">
                                    <div class="row graph-header">
                                        <div class="col-md-6 text-left">
                                            <h3>{{ data.name }}</h3>
                                        </div>
                                        <div class="col-md-6 text-right">
                                            <h3>
                                                <span ng-bind="data.mostRecentValue"></span>
                                                <span ng-if="unit.is_used"
                                                      ng-repeat='unit in data.observation_units'> {{ unit.value_unit }}</span>
                                            </h3>
                                            <span>{{ data.chartLabel[data.chartLabel.length-1]}}</span>
                                        </div>
                                    </div>
                                    <div ng-if="data.observation_components.length > 0">
                                        <canvas chart-data="data.chartData" chart-labels="data.chartLabel"
                                                chart-series="data.chartSeries"
                                                class="chart chart-line"
                                                ng-if="data.graph=='Line'"></canvas>
                                        <canvas chart-data="data.chartData" chart-labels="data.chartLabel"
                                                chart-series="data.chartSeries"
                                                class="chart chart-bar"
                                                ng-if="data.graph=='Bar'"></canvas>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div ng-class="hasPinnedGraph  && hasPinnedMedication ? 'col-md-6' :'col-md-12'" ng-show="hasPinnedMedication">
            <div class='panel panel-default'>
                <div class='panel-heading clearfix'>
                    <a class="pull-left" ng-click="goToMedicationTab()">Medications</a>
                    <i class="fa pull-right" id="addMedicationBtn"
                       ng-class='showMedicationSearch ? "fa-minus":"fa-plus"'
                       ng-click="showMedicationSearch = !showMedicationSearch"></i>
                </div>
                <!--Problem's active medication -->
                <div class='panel-body'>
                    <medication-search ng-show="showMedicationSearch"
                                       on-update="addMedication(value)"></medication-search>

                    <div class="row">
                        <div class='col-md-12'>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Note</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat='medication in medications'
                                    ng-show='medication.current && medication.pin'>
                                    <td>
                                        <a class="cursor-pointer" ng-bind="medication.name"
                                           ng-click='open_medication(medication)'></a>
                                    </td>
                                    <td>
                                <span ng-if="$last"
                                      ng-repeat="note in medication.medication_notes">{{ note.note }}</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Inactive medication toggle button-->
                    <a class='btn btn-default btn-block'
                       ng-click='show_inactive_medications=!show_inactive_medications;'>
                        <span ng-bind='show_inactive_medications? "Hide inactive medications":"Show inactive medications"'></span>
                    </a>

                    <!--Problem's inactive medication -->
                    <div class="row" ng-show="show_inactive_medications">
                        <div class='col-md-12'>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Note</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr ng-repeat='medication in medications'
                                    ng-show='!medication.current && medication.pin'>
                                    <td>
                                        <span class="cursor-pointer"
                                              ng-click='open_medication(medication)'>{{ medication.name }}</span>
                                    </td>
                                    <td>
                                <span ng-if="$last"
                                      ng-repeat="note in medication.medication_notes">{{ note.note }}</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!--START WEIGHTED ORDERING-->
    <section class="auto-ordering">
        <!-- Problem history note -->
        <div class='panel panel-default' ng-style="{order:historyNoteTotal}">
            <div class='panel-heading'> Problem History</div>
            <div class='panel-body'>
                <form class='form' ng-submit="addHistoryNote(historyNoteForm)">
                    <div class='form-group'>
                        <textarea class='form-control' ng-model='historyNoteForm.note' required rows="3"></textarea>
                    </div>
                    <div class='form-group'>
                        <button class='btn btn-default' ng-show="permitted(['modify_problem'])" type='submit'>
                            Update
                        </button>
                    </div>
                </form>
                <span class='text-muted'> <i> Last updated by {{ historyNote.author.first_name }}
				{{ historyNote.author.last_name }} @{{ historyNote.author.username }} -
				{{ historyNote.author.profile.role }} </i>
			</span>
            </div>
        </div>


        <!-- Relationships -->
        <div class='panel panel-default' ng-style="{order:effected_problems.length + effecting_problems.length}">
            <div class='panel-heading' ng-click="editMode=!editMode"> Relationships</div>
            <div class='panel-body'>
                <div class='row'>
                    <div class='col-md-4'>
                        <h4> Effecting Problems <i class='glyphicon glyphicon-arrow-right'></i></h4>
                        <div class='row no-margin' ng-class=" editMode ? 'checkbox' :''"
                             ng-repeat='eff_problem in patient_problems | filter : editMode ? "" : {effecting: true}'>
                            <!--Only show if edit mode is enabled-->
                            <input id="eff{{ eff_problem.id }}"
                                   ng-change='change_effecting_problem(eff_problem, problem)'
                                   ng-disabled='!permitted(["relate_problem"])' ng-if="editMode"
                                   ng-model='eff_problem.effecting'
                                   title="{{ eff_problem.problem_name }}"
                                   type='checkbox'>
                            <label for="eff{{ eff_problem.id }}" ng-if='eff_problem.effecting==true'
                                   style='font-size:14px; font-weight:bold'>
                                <a href='#/problem/{{ eff_problem.id }}'> {{ eff_problem.problem_name }} </a>
                            </label>
                            <label for="eff{{ eff_problem.id }}" ng-if='eff_problem.effecting!=true'>
                                {{ eff_problem.problem_name }}
                            </label>
                        </div>
                    </div>
                    <div class='col-md-4 text-center'>
                        <h3> {{ problem.problem_name }} </h3>
                    </div>
                    <div class='col-md-4'>
                        <h4><i class='glyphicon glyphicon-arrow-right'></i> EffectedProblems </h4>
                        <div class='row no-margin' ng-class=" editMode ? 'checkbox' :''"
                             ng-repeat='eff_problem in patient_problems | filter : editMode ? "" : {effected: true}'>
                            <!--Only show if edit mode is enabled-->
                            <input id="effected_{{ eff_problem.id }}"
                                   ng-change='change_effected_problem(problem, eff_problem)'
                                   ng-disabled='!permitted(["relate_problem"])'
                                   ng-if="editMode" ng-model='eff_problem.effected'
                                   title="{{ eff_problem.problem_name }}"
                                   type='checkbox'>
                            <label for="effected_{{ eff_problem.id }}" ng-if='eff_problem.effected==true'
                                   style='font-size:14px; font-weight:bold'>
                                <a href='#/problem/{{ eff_problem.id }}'> {{ eff_problem.problem_name }} </a>
                            </label>
                            <label for="effected_{{ eff_problem.id }}" ng-if='eff_problem.effected!=true'>
                                {{ eff_problem.problem_name }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-footer text-right">
                <button class="btn btn-default" ng-click="editMode=!editMode">{{ editMode ?'Save':'Edit'}}</button>
            </div>
        </div>

        <!-- Problem encounters-->
        <div class='panel panel-default' id="related-encounters" ng-style="{order:related_encounters.length}">
            <div class='panel-heading' ng-click="encounter_collapse=!encounter_collapse;">
                <i aria-hidden="true" class="fa fa-caret-down" ng-if="encounter_collapse"></i>
                <i aria-hidden="true" class="fa fa-caret-right" ng-if="!encounter_collapse"></i>
                Related Encounters ({{ related_encounters.length }})
            </div>
            <div class='panel-body' ng-show="encounter_collapse" style='max-height:275px; overflow:auto;padding:15px;'>
                <a class="encounter-item" href='#/encounter/{{ encounter.id }}'
                   ng-repeat='encounter in related_encounters track by $index'> {{ encounter.starttime|date }}</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <!--Uploaded document-->
                <div class="panel panel-default uploaded_document" ng-style="{order:pinned_document.length}">
                    <div class="panel-heading">
                        <p>Pinned document</p>
                    </div>
                    <div class="panel-body">
                        <ul class="ul-clean no-padding">
                            <li ng-repeat="document in pinned_document | orderBy:'created_on':true track by $index">
                                <div>
                                    <a class="todo-label-front" ng-class="label.css_class"
                                       ng-repeat="label in document.labels track by $index"><span
                                            class="todo-label-name"
                                            ng-bind="label.name"></span></a>
                                    <a class="flex-item document_name" href="#/document/{{ document.id }}"
                                       ng-bind="document.document_name"></a>
                                    <span class="flex-item document_uploaded_date pull-right"
                                          ng-bind="document.created_on | date:'MM/dd/yyyy'"></span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!--Problem images-->
                <div class='panel panel-default' id="problem-image" ng-style="{order:problem_images.length}">
                    <div class='panel-heading'> Images <span ng-show='permitted(["add_problem_image"])'>
				    <button accept="image/*" class='btn btn-sm btn-default' multiple
                            ngf-max-files="5" ngf-select="open_image_upload_box($files)"> Upload </button>
			        </span>
                    </div>
                    <div class='panel-body'>
                        <div masonry="{ gutter: 10}">
                            <div class="masonry-brick" ng-repeat='image in problem_images track by $index'>
                                <i class="fa fa-times" ng-click='delete_problem_image(image)'
                                   ng-show='permitted(["delete_problem_image"])'
                                   title="Delete image"></i>
                                <a class="problem-images-gallery" fancyboxable="img-{{$index}}" href='{{ image.image }}'
                                   id="img-{{$index}}" rel="problem-images-gallery">
                                    <img alt="img-{{$index}}" load-images="true" ng-src='{{ image.image }}'/>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!--Problem activities-->
    <section class='panel panel-default'>
        <div class='panel-heading' ng-click="problem_activity_collapse=!problem_activity_collapse;">
            <i aria-hidden="true" class="fa fa-caret-down" ng-if="problem_activity_collapse"></i>
            <i aria-hidden="true" class="fa fa-caret-right" ng-if="!problem_activity_collapse"></i>
            Problem activity
            <button class="btn btn-default"
                    ng-click="problem_activity_see_all=!problem_activity_see_all; $event.stopPropagation();"
                    ng-show="problem_activity_collapse">See
                all
            </button>
        </div>
        <div class='panel-body' ng-show="problem_activity_collapse" style='max-height:375px; overflow:auto;'>
            <div class='row activity-item' ng-repeat='activity in activities'
                 ng-show="problem_activity_see_all || activity.is_input_type || activity.is_output_type"
                 style='margin-bottom:4px; border-top:1px solid #ccc;'>
                <div class='col-md-3'>
                    <b>{{ activity.author.first_name }} {{ activity.author.last_name }} - {{
                        activity.author.profile.role }} </b>
                </div>
                <div class='col-md-7'>
                            <span ng-if="activity.is_input_type"><i aria-hidden="true"
                                                                    class="fa fa-caret-right"></i></span>
                    <span ng-if="activity.is_output_type"><i aria-hidden="true"
                                                             class="fa fa-caret-left"></i></span>
                    <span ng-bind-html='activity.activity'></span>
                </div>
                <div class='col-md-2'>
                    {{ activity.created_on | date }}
                </div>
            </div>
        </div>
    </section>

    <!--Goals-->
    <section class='panel panel-default'>
        <div class='panel-heading'> Goals</div>
        <div class='panel-body'>
            <div class='row'>
                <div class='col-md-12'>
                    <form ng-show='permitted(["add_goal"])' ng-submit='add_goal(goal_form)'>
                        <div class="input-group">
                            <input class='form-control' id='goalNameInput' ng-model='goal_form.name' title="Goal"
                                   type='text'>
                            <span class="input-group-btn">
                            <input class='btn btn-primary' type='submit' value='Submit'></span>
                        </div>
                    </form>
                    <ul class='list-group'>
                        <li class="text-center" ng-show='!problem_goals.length'> No Goals</li>
                        <li class='list-group-item' ng-class='goal.is_controlled==true ? "green-box" : "red-box" '
                            ng-repeat='goal in problem_goals'
                            ng-show='goal.accomplished==false'>
                            <a class='btn btn-default' href='#/goal/{{ goal.id }}'> View </a>
                            {{ goal.goal }}
                        </li>
                    </ul>
                    <button class='btn btn-default btn-block' ng-click='toggle_accomplished_goals()'>
                        <span ng-if='show_accomplished_goals==false'>Show accomplished Goals </span>
                        <span ng-if='show_accomplished_goals==true'>Hide accomplished Goals </span>
                    </button>
                    <ul class='list-group' ng-if='show_accomplished_goals==true'>
                        <li class="text-center" ng-show='!problem_goals.length'> No Goals</li>
                        <li class='list-group-item' ng-class='goal.is_controlled==true ? "green-box" : "red-box" '
                            ng-repeat='goal in problem_goals'
                            ng-show='goal.accomplished==true'>
                            <a class='btn btn-default' href='#/goal/{{ goal.id }}'> View </a>
                            {{ goal.goal }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <div class="overlay" ng-click="edit_problem = false" ng-show="edit_problem"></div>
</section>